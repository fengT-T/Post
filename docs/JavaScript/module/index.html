<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript 模块揭秘 | T-T</title>
    <meta name="description" content="fengT-T的Github Page">
    
    
    <link rel="preload" href="/Post/assets/css/0.styles.1183ec13.css" as="style"><link rel="preload" href="/Post/assets/js/app.4a793c4a.js" as="script"><link rel="preload" href="/Post/assets/js/2.17ef4d92.js" as="script"><link rel="preload" href="/Post/assets/js/7.e721c46e.js" as="script"><link rel="prefetch" href="/Post/assets/js/10.28fa0eaa.js"><link rel="prefetch" href="/Post/assets/js/11.5969fff0.js"><link rel="prefetch" href="/Post/assets/js/12.f46c288c.js"><link rel="prefetch" href="/Post/assets/js/13.6a52cbae.js"><link rel="prefetch" href="/Post/assets/js/14.2975bfee.js"><link rel="prefetch" href="/Post/assets/js/15.99b8c725.js"><link rel="prefetch" href="/Post/assets/js/16.15a8cc64.js"><link rel="prefetch" href="/Post/assets/js/17.1f68dd7b.js"><link rel="prefetch" href="/Post/assets/js/18.c70a5119.js"><link rel="prefetch" href="/Post/assets/js/19.6b844ff3.js"><link rel="prefetch" href="/Post/assets/js/20.517b8dde.js"><link rel="prefetch" href="/Post/assets/js/21.11abe68c.js"><link rel="prefetch" href="/Post/assets/js/22.8a11e9a0.js"><link rel="prefetch" href="/Post/assets/js/23.695b0b23.js"><link rel="prefetch" href="/Post/assets/js/24.782d7c27.js"><link rel="prefetch" href="/Post/assets/js/25.4c62b3f0.js"><link rel="prefetch" href="/Post/assets/js/26.6bbd0a9c.js"><link rel="prefetch" href="/Post/assets/js/3.cd434c65.js"><link rel="prefetch" href="/Post/assets/js/4.fef01a1c.js"><link rel="prefetch" href="/Post/assets/js/5.2f9f64bc.js"><link rel="prefetch" href="/Post/assets/js/6.84bbb810.js"><link rel="prefetch" href="/Post/assets/js/8.3ee2bcda.js"><link rel="prefetch" href="/Post/assets/js/9.e5096dd9.js">
    <link rel="stylesheet" href="/Post/assets/css/0.styles.1183ec13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Post/" class="home-link router-link-active"><!----> <span class="site-name">T-T</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Post/JavaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/Post/Other/" class="nav-link">Other</a></div><div class="nav-item"><a href="/Post/CoCoMusic/index.html" class="nav-link">CoCoMusic</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Post/JavaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/Post/Other/" class="nav-link">Other</a></div><div class="nav-item"><a href="/Post/CoCoMusic/index.html" class="nav-link">CoCoMusic</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript 模块揭秘</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Post/JavaScript/module/#js-模块黑历史" class="sidebar-link">js 模块黑历史</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#iife" class="sidebar-link">IIFE</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#commonjs-模块规范" class="sidebar-link">CommonJS 模块规范</a></li></ul></li><li><a href="/Post/JavaScript/module/#模块分类" class="sidebar-link">模块分类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#系统模块" class="sidebar-link">系统模块</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#第三方模块-与-commonjs" class="sidebar-link">第三方模块 与 CommonJS</a></li></ul></li><li><a href="/Post/JavaScript/module/#commonjs-实现" class="sidebar-link">CommonJS 实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#module-构造函数" class="sidebar-link">Module 构造函数</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#require-加载模块" class="sidebar-link">require 加载模块</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#猜出模块的路径" class="sidebar-link">猜出模块的路径</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#猜文件夹路径" class="sidebar-link">猜文件夹路径</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#通过可能的路径列表猜初最终的文件路径" class="sidebar-link">通过可能的路径列表猜初最终的文件路径</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#系统缓存" class="sidebar-link">系统缓存</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#模块加载机制" class="sidebar-link">模块加载机制</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#compile-函数" class="sidebar-link">_compile 函数</a></li></ul></li><li><a href="/Post/JavaScript/module/#模块循环引用" class="sidebar-link">模块循环引用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Post/JavaScript/module/#webpack-模块" class="sidebar-link">webpack 模块</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Post/JavaScript/module/#es6-模块-vs-commonjs" class="sidebar-link">ES6 模块 VS CommonJS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#commonjs-动态加载-vs-import" class="sidebar-link">CommonJS 动态加载 VS import()</a></li><li class="sidebar-sub-header"><a href="/Post/JavaScript/module/#es6模块的值引用-vs-commonjs-的值拷贝" class="sidebar-link">ES6模块的值引用 VS CommonJS 的值拷贝</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="javascript-模块揭秘"><a href="#javascript-模块揭秘" class="header-anchor">#</a> JavaScript 模块揭秘</h1> <h2 id="js-模块黑历史"><a href="#js-模块黑历史" class="header-anchor">#</a> js 模块黑历史</h2> <h3 id="iife"><a href="#iife" class="header-anchor">#</a> IIFE</h3> <p>IIFE（ 立即调用函数表达式）是一个在定义时就会立即执行的  JavaScript 函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statements
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这是一个被称为 <code>自执行匿名函数</code> 的设计模式，主要包含两部分。第一部分是包围在 圆括号运算符<code>()</code>里的一个匿名函数，这个匿名函数拥有独立的词法作用域。这不仅避免了外界访问此 <code>IIFE</code> 中的变量，而且又不会污染全局作用域。</p> <h3 id="commonjs-模块规范"><a href="#commonjs-模块规范" class="header-anchor">#</a> CommonJS 模块规范</h3> <p>Node 的 CommonJS 模块的特点如下。（阮一峰写的）</p> <ul><li>所有代码都运行在模块作用域，不会污染全局作用域。</li> <li>模块可以多次加载，但是只会在第一次加载时运行一次，然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。</li> <li>模块加载的顺序，按照其在代码中出现的顺序。</li></ul> <h2 id="模块分类"><a href="#模块分类" class="header-anchor">#</a> 模块分类</h2> <p>根据实现分为：</p> <ul><li>系统模块（node内置的模块）</li> <li>第三方模块（开发者写的模块）</li></ul> <h3 id="系统模块"><a href="#系统模块" class="header-anchor">#</a> 系统模块</h3> <ul><li>核心模块（NativeModule），http、buffer、fs 等，把内建模块 (C/C++)的包装成 CommonJS 模块给开发者调用；</li> <li>C/C++ 写成的内建模块（internalBinding），供 核心模块（NativeModule）调用；</li></ul> <p>c/c++ 内建模块是可以通过 process.binding 方法调用的，例子如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> access<span class="token punctuation">,</span> FSReqCallback <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">binding</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pathModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSReqCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
req<span class="token punctuation">.</span><span class="token function-variable function">oncomplete</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'可以访问'</span><span class="token punctuation">)</span>
<span class="token function">access</span><span class="token punctuation">(</span>pathModule<span class="token punctuation">.</span><span class="token function">toNamespacedPath</span><span class="token punctuation">(</span><span class="token string">'./module.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span>
</code></pre></div><p>返回结果</p> <div class="language-bash extra-class"><pre class="language-bash"><code>➜ <span class="token builtin class-name">test</span> node internalBinding.js
可以访问
</code></pre></div><p>一旦系统模块出错就会导致整个node进程当场挂掉</p> <div class="language-bash extra-class"><pre class="language-bash"><code>➜ <span class="token builtin class-name">test</span> node internalBinding.js
node<span class="token punctuation">[</span><span class="token number">15259</span><span class="token punctuation">]</span>: <span class="token punctuation">..</span>/src/node_file.cc:732:void node::fs::Access<span class="token punctuation">(</span>const v8::FunctionCallbackInfo<span class="token operator">&lt;</span>v8::Value<span class="token operator">&gt;&amp;</span><span class="token punctuation">)</span>: Assertion `args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>-<span class="token operator">&gt;</span>IsInt32<span class="token punctuation">(</span><span class="token punctuation">)</span>' failed.
 <span class="token number">1</span>: 0x55936c2aa751 node::Abort<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
 <span class="token number">2</span>: 0x55936c2aa7f1  <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
 <span class="token number">3</span>: 0x55936c2b887d node::fs::Access<span class="token punctuation">(</span>v8::FunctionCallbackInfo<span class="token operator">&lt;</span>v8::Value<span class="token operator">&gt;</span> const<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
 <span class="token number">4</span>: 0x55936c482f07 v8::internal::FunctionCallbackArguments::Call<span class="token punctuation">(</span>v8::internal::CallHandlerInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
 <span class="token number">5</span>: 0x55936c4832d1  <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
 <span class="token number">6</span>: 0x55936c483b8a  <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
 <span class="token number">7</span>: 0x55936c4844a6 v8::internal::Builtin_HandleApiCall<span class="token punctuation">(</span>int, unsigned long*, v8::internal::Isolate*<span class="token punctuation">)</span> <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
 <span class="token number">8</span>: 0x55936cc0d9d9  <span class="token punctuation">[</span>node<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token number">15259</span> abort <span class="token punctuation">(</span>core dumped<span class="token punctuation">)</span>  node internalBinding.js
</code></pre></div><h3 id="第三方模块-与-commonjs"><a href="#第三方模块-与-commonjs" class="header-anchor">#</a> 第三方模块 与 CommonJS</h3> <p>node_modules 里面的模块 和 本地维护的模块（以路径形式的文件模块）都属于第三方模块</p> <h2 id="commonjs-实现"><a href="#commonjs-实现" class="header-anchor">#</a> CommonJS 实现</h2> <h3 id="module-构造函数"><a href="#module-构造函数" class="header-anchor">#</a> Module 构造函数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span> <span class="token comment">// 模块 id 其实就是模块的绝对路径, main 是 .</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当前模块的文件夹路径</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 表示模块对外输出的值</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span> <span class="token comment">// 表示调用该模块的模块</span>
 <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 模块的文件的绝对路径。</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 模块是否加载完成 </span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 当前模块所引用的模块</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>Module <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module/a.js'</span><span class="token punctuation">,</span>
  path<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module'</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  parent<span class="token operator">:</span> Module <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  filename<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module/a.js'</span><span class="token punctuation">,</span>
  loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>Module <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  paths<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'/home/feng/Documents/note/test/module/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/feng/Documents/note/test/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/feng/Documents/note/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/feng/Documents/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/feng/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/home/node_modules'</span><span class="token punctuation">,</span>
    <span class="token string">'/node_modules'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="require-加载模块"><a href="#require-加载模块" class="header-anchor">#</a> require 加载模块</h3> <p>require 加载模块分两步：</p> <ol><li>猜出模块的路径</li> <li>然后通过路径加载模块给开发者</li></ol> <h3 id="猜出模块的路径"><a href="#猜出模块的路径" class="header-anchor">#</a> 猜出模块的路径</h3> <ul><li>先猜出可能存在的文件夹路径</li> <li>从一堆文件夹路径列表找出模块的路径</li></ul> <h3 id="猜文件夹路径"><a href="#猜文件夹路径" class="header-anchor">#</a> 猜文件夹路径</h3> <p>猜文件夹路径也分两种情况</p> <ul><li>项目内模块（相对路径或绝对路径 形如 <code>./module/a</code>）</li> <li>第三方包 (vue，<code>/^[^.][^./]?/</code>) （第一个字符不是<code>.</code>第二个字符不能是<code>.</code>或<code>/</code>,第二个字符可以没有）</li></ul> <p>项目内模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module/a'</span><span class="token punctuation">)</span>

<span class="token comment">// 路径列表</span>
paths <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'/home/feng/Documents/note/test'</span> <span class="token punctuation">]</span>
</code></pre></div><p>第三方包</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue'</span><span class="token punctuation">)</span>

<span class="token comment">// 路径列表 = 当前路径到根目录的 node_modules + 全局模块路径</span>
paths <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'/home/feng/Documents/note/test/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/home/feng/Documents/note/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/home/feng/Documents/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/home/feng/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/home/node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/node_modules'</span><span class="token punctuation">,</span>

  <span class="token string">'/home/feng/.node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/home/feng/.node_libraries'</span><span class="token punctuation">,</span>
  <span class="token string">'/usr/lib/node'</span>
<span class="token punctuation">]</span>
<span class="token comment">// 全局模块路径</span>
globalPaths<span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'/home/feng/.node_modules'</span><span class="token punctuation">,</span>
  <span class="token string">'/home/feng/.node_libraries'</span><span class="token punctuation">,</span>
  <span class="token string">'/usr/lib/node'</span>
<span class="token punctuation">]</span>
</code></pre></div><h3 id="通过可能的路径列表猜初最终的文件路径"><a href="#通过可能的路径列表猜初最终的文件路径" class="header-anchor">#</a> 通过可能的路径列表猜初最终的文件路径</h3> <p>通过 路径列表 挨个测试 来得到文件的最终路径</p> <ol><li><p>路径 + 模块名</p></li> <li><p>路径 + 模块名 + 后缀</p></li> <li><p>路径 + 模块名 + package.json, 取 main 字段对应的路径</p></li> <li><p>如果没有 main， 路径 + 模块名 + index + 后缀（最后的倔强）</p></li> <li><p><code>/home/feng/test</code> + <code>./module/a</code></p></li> <li><p><code>/home/feng/test</code> + <code>./module/a</code> + <code>['.js', '.json' + '.node']</code></p></li> <li><p><code>/home/feng/test</code> + <code>./module/a/</code> + <code>package.json</code></p></li> <li><p><code>/home/feng/test</code> + <code>./module/a/</code> + <code>index</code> + <code>['.js', '.json' + '.node']</code></p></li></ol> <h3 id="系统缓存"><a href="#系统缓存" class="header-anchor">#</a> 系统缓存</h3> <p>一个模块被执行后会被缓存起来，提高再次加载速度；
实际上就是一个 filename 为 Key， Moduel 为 Value 的 对象，找到路径路径之后先去找缓存，命中缓存就直接返回缓存的对象</p> <div class="language-js extra-class"><pre class="language-js"><code>require<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'/home/feng/Documents/note/test/module.js'</span><span class="token operator">:</span> Module <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module.js'</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'/home/feng/Documents/note/test/module/a.js'</span><span class="token operator">:</span> Module <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module/a.js'</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module/a.js'</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'/home/feng/Documents/note/test/module/b.js'</span><span class="token operator">:</span> Module <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module/b.js'</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'/home/feng/Documents/note/test/module/b.js'</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="模块加载机制"><a href="#模块加载机制" class="header-anchor">#</a> 模块加载机制</h3> <p>找到路径之后 通过 扩展名 来调用 Module._extensions 里面的函数进行模块加载</p> <div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
Module<span class="token punctuation">.</span>_extensions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'.js'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">Function</span> <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">'.json'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">Function</span> <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">'.node'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">Function</span> <span class="token punctuation">(</span>anonymous<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>.json 比较粗暴直接 JSON.parse</li> <li>.node 调用了 process.dlopen 加载动态链接库</li> <li>.js 调用了 _compile 函数</li></ul> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span><span class="token function">stripBOM</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Native extension for .json</span>
Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.json'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">stripBOM</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err<span class="token punctuation">.</span>message <span class="token operator">=</span> filename <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Native extension for .node</span>
Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.node'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Be aware this doesn't use `content`</span>
  <span class="token keyword">return</span> process<span class="token punctuation">.</span><span class="token function">dlopen</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">toNamespacedPath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="compile-函数"><a href="#compile-函数" class="header-anchor">#</a> _compile 函数</h3> <p>_compile 函数 调用 Module.wrap 返回了一个 字符串, 然后将这个 字符串 放到 vm.runInThisContext 里面执行</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token comment">// Run the file contents in the correct scope or sandbox. Expose</span>
<span class="token comment">// the correct helper variables (require, module, exports) to</span>
<span class="token comment">// the file.</span>
<span class="token comment">// Returns exception, if any.</span>
<span class="token class-name">Module</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> compiledWrapper<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>patched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapper <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compiledWrapper <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 省略很多代码</span>
  <span class="token keyword">var</span> result<span class="token punctuation">;</span>
  <span class="token keyword">const</span> exports <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token keyword">const</span> thisValue <span class="token operator">=</span> exports<span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token function">compiledWrapper</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>thisValue<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>runInThisContext 实际上类似于 eval,只是有些细微的差别</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token string">'Hello World'</span>
vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token string">'console.log(a)'</span><span class="token punctuation">)</span>

<span class="token comment">// Hello World</span>
</code></pre></div><p>IIFE？？？</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">script</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> script <span class="token operator">+</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'(function (exports, require, module, __filename, __dirname) { '</span><span class="token punctuation">,</span>
  <span class="token string">'\n});'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>为什么需要写成 IIFE 的形式， 因为  不能让 vm.runInThisContext 里面的代码访问到外面的变量</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vm'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> localVar <span class="token operator">=</span> <span class="token string">'initial value'</span>

vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span><span class="token string">'(function(){console.log(localVar)})()'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>evalmachine.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span>:1
<span class="token punctuation">(</span><span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console.log<span class="token punctuation">(</span>localVar<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        ^

ReferenceError: loalVar is not defined
</code></pre></div><h2 id="模块循环引用"><a href="#模块循环引用" class="header-anchor">#</a> 模块循环引用</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//a.js</span>
exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">'a'</span>

<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span>a2 <span class="token operator">=</span> <span class="token string">'a2'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b ='</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token comment">// { b: 'b' }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a.exports ='</span><span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token comment">// { a: 'a', a2: 'a2' }</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//b.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'require.cache = '</span><span class="token punctuation">,</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">)</span>

<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a = '</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token comment">// { a: 'a' }</span>

exports<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token string">'b'</span>
</code></pre></div><p>结果</p> <div class="language-bash extra-class"><pre class="language-bash"><code>➜  <span class="token builtin class-name">test</span> node module/a.js
require.cache <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'/home/feng/Documents/note/test/module/a.js'</span><span class="token builtin class-name">:</span> Module <span class="token punctuation">{</span><span class="token punctuation">..</span>.<span class="token punctuation">}</span>,
  <span class="token string">'/home/feng/Documents/note/test/module/b.js'</span><span class="token builtin class-name">:</span> Module <span class="token punctuation">{</span><span class="token punctuation">..</span>.<span class="token punctuation">}</span>,
<span class="token punctuation">}</span>
a <span class="token operator">=</span>  <span class="token punctuation">{</span> a: <span class="token string">'a'</span> <span class="token punctuation">}</span>
b <span class="token operator">=</span> <span class="token punctuation">{</span> b: <span class="token string">'b'</span> <span class="token punctuation">}</span>
a.exports <span class="token operator">=</span> <span class="token punctuation">{</span> a: <span class="token string">'a'</span>, a2: <span class="token string">'a2'</span> <span class="token punctuation">}</span>
</code></pre></div><p><img src="/Post/assets/img/cache.45c17b2f.svg" alt="模块循环引用"></p> <p>因为有缓存的存在 a.js 被执行的时候已经就已经加入到了缓存列表中了，在 b 中 require a 并不会再次执行 a.js 而是直接从缓存中取出 a.js 的 module 的 exports 返回</p> <h2 id="webpack-模块"><a href="#webpack-模块" class="header-anchor">#</a> webpack 模块</h2> <p>对于 webpack 来说任何东西都可以是模块，一个简单的 <code>webpack</code> 打包结果如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>npx webpack --mode development
</code></pre></div><p>输入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ./src/a.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">'T_T'</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ./src/index.js</span>
<span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
</code></pre></div><p>输出（简化版）：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// moduleId 就是路径</span>
        <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span>
            exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">&quot;./src/a.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;module.exports = 'T—T';\n\n\n//# sourceURL=webpack:///./src/a.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;const str = __webpack_require__(/*! ./a.js */ \&quot;./src/a.js\&quot;);\nconsole.log(str);\n\n\n//# sourceURL=webpack:///./src/index.js?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="es6-模块-vs-commonjs"><a href="#es6-模块-vs-commonjs" class="header-anchor">#</a> ES6 模块 VS CommonJS</h2> <p>ES6 的模块和 CommonJS 大体上是相似的，区别如下：</p> <ul><li>ES6 模块是静态加载的,CommonJS可以动态加载</li> <li>ES6 模块输出的是对应值的引用，是一种动态绑定关系，通过该接口可以获取模块内部实时的值。CommonJS模块输出的是值的缓存。</li></ul> <h3 id="commonjs-动态加载-vs-import"><a href="#commonjs-动态加载-vs-import" class="header-anchor">#</a> CommonJS 动态加载 VS import()</h3> <p>CommonJS 的 require 是可以有条件的动态执行的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">let</span> home <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'linux'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  home <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>home<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HOME</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>➜  <span class="token builtin class-name">test</span> node index.js 
/home/feng
</code></pre></div><p>如果在 ES6 模块里面这么写会直接报语法错误，导入导出必须在 <code>模块顶层</code>， 一旦出现在<code>块级作用域</code>内，就会报错。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>➜  <span class="token builtin class-name">test</span> node --experimental-modules  ./index.mjs
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.mjs</span>
<span class="token keyword">let</span> home
<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'linux'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span> home <span class="token keyword">from</span> <span class="token string">'./a.mjs'</span><span class="token punctuation">;</span> <span class="token comment">// SyntaxError: Unexpected identifier</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>home<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.mjs</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HOME</span>
</code></pre></div><p>新的提案里面引入<code>import()</code>函数来动态异步导入模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.mjs</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>platform <span class="token operator">===</span> <span class="token string">'linux'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> home <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./a.mjs'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>home<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.mjs</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HOME</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>➜  <span class="token builtin class-name">test</span> node --experimental-modules  ./index.mjs
<span class="token punctuation">(</span>node:13578<span class="token punctuation">)</span> ExperimentalWarning: The ESM module loader is experimental.
/home/feng
</code></pre></div><h3 id="es6模块的值引用-vs-commonjs-的值拷贝"><a href="#es6模块的值引用-vs-commonjs-的值拷贝" class="header-anchor">#</a> ES6模块的值引用 VS CommonJS 的值拷贝</h3> <p>CommonJS 导出返回的是一个普通的复制拷贝</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token comment">// 3</span>
mod<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>num<span class="token punctuation">)</span> <span class="token comment">// 3</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">3</span>
<span class="token keyword">function</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token parameter">b <span class="token operator">=</span> <span class="token number">4</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  num <span class="token operator">=</span> b
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  num<span class="token punctuation">,</span>
  change<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>➜  <span class="token builtin class-name">test</span> node index.js 
<span class="token number">3</span>
<span class="token number">3</span>
</code></pre></div><p>ES6 模块返回的是一个是一个对模块内部变量的绑定，因此我们可以获取到最新的值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.mjs</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> mod <span class="token keyword">from</span> <span class="token string">'./a.mjs'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
mod<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.mjs</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">3</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token parameter">b <span class="token operator">=</span> <span class="token number">4</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  num <span class="token operator">=</span> b
<span class="token punctuation">}</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>➜  <span class="token builtin class-name">test</span> node --experimental-modules  ./index.mjs
<span class="token punctuation">(</span>node:13995<span class="token punctuation">)</span> ExperimentalWarning: The ESM module loader is experimental.
<span class="token number">3</span>
<span class="token number">4</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/Post/assets/js/app.4a793c4a.js" defer></script><script src="/Post/assets/js/2.17ef4d92.js" defer></script><script src="/Post/assets/js/7.e721c46e.js" defer></script>
  </body>
</html>
